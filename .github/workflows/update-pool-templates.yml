name: Update Mining4People Pool Templates

on:
  # Run daily at midnight UTC
  schedule:
    - cron: '0 0 * * *'
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      create_pr:
        description: 'Create a pull request to upstream'
        required: false
        default: 'true'
        type: boolean

env:
  UPSTREAM_REPO: hive-os/hive-pooltemplates

jobs:
  update-pool-templates:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add upstream remote and sync
        id: sync_upstream
        run: |
          # Add upstream remote if it doesn't exist
          if ! git remote get-url upstream > /dev/null 2>&1; then
            git remote add upstream "https://github.com/${{ env.UPSTREAM_REPO }}.git"
          fi
          git fetch upstream
          
          # Determine which branch to use (master or main)
          UPSTREAM_BRANCH=""
          if git ls-remote --heads upstream master | grep -q master; then
            UPSTREAM_BRANCH="master"
          elif git ls-remote --heads upstream main | grep -q main; then
            UPSTREAM_BRANCH="main"
          else
            echo "Error: Could not find master or main branch on upstream"
            exit 1
          fi
          
          echo "upstream_branch=$UPSTREAM_BRANCH" >> "$GITHUB_OUTPUT"
          
          # Checkout local branch and merge upstream
          git checkout "$UPSTREAM_BRANCH" || git checkout -b "$UPSTREAM_BRANCH" "upstream/$UPSTREAM_BRANCH"
          git merge "upstream/$UPSTREAM_BRANCH" --no-edit || echo "Already up to date or no upstream changes"

      - name: Update pool templates
        run: |
          # This step updates the mining4people.json and mining4people-solo.json files.
          # Customize this section to fetch data from your pool's API or data source.
          # 
          # Example: Fetch from an API endpoint
          # curl -s "https://api.mining4people.com/pool-config" | jq '.' > pool_templates/mining4people.json
          #
          # For now, this workflow expects manual updates to the files or
          # you can add your custom update logic here.
          
          if [ -d "pool_templates" ]; then
            echo "Pool templates directory found"
            
            # Ensure the files exist
            if [ -f "pool_templates/mining4people.json" ]; then
              echo "mining4people.json exists and is ready for updates"
            else
              echo "Warning: mining4people.json not found"
            fi
            
            if [ -f "pool_templates/mining4people-solo.json" ]; then
              echo "mining4people-solo.json exists and is ready for updates"
            else
              echo "Warning: mining4people-solo.json not found"
            fi
          else
            echo "Error: pool_templates directory not found"
            exit 1
          fi

      - name: Validate JSON files
        run: |
          echo "Validating JSON files..."
          validation_failed=false
          
          if [ -f "pool_templates/mining4people.json" ]; then
            if python3 -m json.tool pool_templates/mining4people.json > /dev/null 2>&1; then
              echo "✓ mining4people.json is valid JSON"
            else
              echo "✗ mining4people.json has invalid JSON syntax"
              validation_failed=true
            fi
          else
            echo "⚠ mining4people.json not found, skipping validation"
          fi
          
          if [ -f "pool_templates/mining4people-solo.json" ]; then
            if python3 -m json.tool pool_templates/mining4people-solo.json > /dev/null 2>&1; then
              echo "✓ mining4people-solo.json is valid JSON"
            else
              echo "✗ mining4people-solo.json has invalid JSON syntax"
              validation_failed=true
            fi
          else
            echo "⚠ mining4people-solo.json not found, skipping validation"
          fi
          
          if [ "$validation_failed" = true ]; then
            echo "JSON validation failed"
            exit 1
          fi
          
          echo "JSON validation passed"

      - name: Check for changes
        id: check_changes
        run: |
          if git diff --quiet && git diff --cached --quiet; then
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
            echo "No changes detected"
          else
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
            echo "Changes detected:"
            git diff --stat
          fi

      - name: Commit changes
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          # Only add files that exist
          if [ -f "pool_templates/mining4people.json" ]; then
            git add pool_templates/mining4people.json
          fi
          if [ -f "pool_templates/mining4people-solo.json" ]; then
            git add pool_templates/mining4people-solo.json
          fi
          git commit -m "Update mining4people pool templates" || echo "No changes to commit"

      - name: Push changes to fork
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git push origin HEAD

      - name: Create Pull Request to upstream
        if: steps.check_changes.outputs.has_changes == 'true' && (github.event.inputs.create_pr == 'true' || github.event_name == 'schedule')
        env:
          GH_TOKEN: ${{ secrets.UPSTREAM_PAT }}
          UPSTREAM_REPO: ${{ env.UPSTREAM_REPO }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_REPOSITORY_OWNER: ${{ github.repository_owner }}
          UPSTREAM_BRANCH: ${{ steps.sync_upstream.outputs.upstream_branch }}
        run: |
          # Create a PR to the upstream repository using GitHub CLI
          # The PR will be created from this fork to the upstream repo
          
          BRANCH_NAME="update-mining4people-templates-$(date +%Y%m%d)"
          
          # Create and push a new branch for the PR
          git checkout -b "$BRANCH_NAME"
          git push origin "$BRANCH_NAME"
          
          # Create the pull request body
          PR_BODY="This PR updates the Mining4People pool templates with the latest configuration.

          Updated files:
          - pool_templates/mining4people.json
          - pool_templates/mining4people-solo.json

          This PR was automatically generated by the update-pool-templates workflow."
          
          # Create the pull request using gh CLI
          gh pr create \
            --repo "$UPSTREAM_REPO" \
            --head "$GITHUB_REPOSITORY_OWNER:$BRANCH_NAME" \
            --base "$UPSTREAM_BRANCH" \
            --title "Update Mining4People pool templates" \
            --body "$PR_BODY" \
            || echo "PR creation failed or PR already exists"
