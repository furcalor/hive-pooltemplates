name: Update Mining4People Pool Templates

on:
  # Run daily at midnight UTC
  schedule:
    - cron: '0 0 * * *'
  # Allow manual trigger
  workflow_dispatch:
    inputs:
      create_pr:
        description: 'Create a pull request to upstream'
        required: false
        default: 'true'
        type: boolean

jobs:
  update-pool-templates:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add upstream remote and sync
        run: |
          git remote add upstream https://github.com/hive-os/hive-pooltemplates.git || true
          git fetch upstream
          git checkout master || git checkout main
          git merge upstream/master --no-edit || git merge upstream/main --no-edit || echo "Already up to date or no upstream changes"

      - name: Update mining4people.json
        run: |
          # Check if the pool_templates directory exists
          if [ -d "pool_templates" ]; then
            echo "Updating mining4people.json..."
            # The mining4people.json file should be updated from source
            # This copies from the current repository's pool_templates directory
            # In a real scenario, this would fetch from an API or external source
            if [ -f "pool_templates/mining4people.json" ]; then
              echo "mining4people.json found and ready for update"
            fi
          fi

      - name: Update mining4people-solo.json
        run: |
          # Check if the pool_templates directory exists
          if [ -d "pool_templates" ]; then
            echo "Updating mining4people-solo.json..."
            # The mining4people-solo.json file should be updated from source
            if [ -f "pool_templates/mining4people-solo.json" ]; then
              echo "mining4people-solo.json found and ready for update"
            fi
          fi

      - name: Validate JSON files
        run: |
          echo "Validating JSON files..."
          python3 -m json.tool pool_templates/mining4people.json > /dev/null
          python3 -m json.tool pool_templates/mining4people-solo.json > /dev/null
          echo "JSON validation passed"

      - name: Check for changes
        id: check_changes
        run: |
          if git diff --quiet; then
            echo "has_changes=false" >> "$GITHUB_OUTPUT"
          else
            echo "has_changes=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Commit changes
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git add pool_templates/mining4people.json pool_templates/mining4people-solo.json
          git commit -m "Update mining4people pool templates" || echo "No changes to commit"

      - name: Push changes to fork
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git push origin HEAD

      - name: Create Pull Request to upstream
        if: steps.check_changes.outputs.has_changes == 'true' && (github.event.inputs.create_pr == 'true' || github.event_name == 'schedule')
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.UPSTREAM_PAT }}
          push-to-fork: ${{ github.repository }}
          branch: update-mining4people-templates
          title: "Update Mining4People pool templates"
          body: |
            This PR updates the Mining4People pool templates with the latest configuration.
            
            Updated files:
            - `pool_templates/mining4people.json`
            - `pool_templates/mining4people-solo.json`
            
            This PR was automatically generated by the [update-pool-templates workflow](https://github.com/${{ github.repository }}/actions/workflows/update-pool-templates.yml).
          labels: |
            automated
            pool-update
